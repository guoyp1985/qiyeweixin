<template>
  <div class="containerarea font14">
    <subscribe v-if="loginUser.subscribe != 1 && !loginUser.isretailer"></subscribe>
    <template v-if="showSetting">
      <retailer-setting
        ref="retailerSetting"
        :query="query"
        :retailer-info="retailerInfo"
        :login-user="loginUser"
        :photoarr="photoarr"
        :showphoto-arr="showphotoArr"
        :submitdata="submitdata"
        :submitdata1="submitdata1">
      </retailer-setting>
    </template>
    <template v-if="showApply">
      <retailer-apply :login-user="loginUser" :after-apply="applySuccess" :class-data="classData"></retailer-apply>
    </template>
  </div>
</template>

<i18n>
</i18n>

<script>
import RetailerSetting from '@/components/RetailerSetting'
import RetailerApply from '@/components/RetailerApply'
import Subscribe from '@/components/Subscribe'
import ENV from 'env'
import { User } from '#/storage'

export default {
  components: {
    RetailerSetting, RetailerApply, Subscribe
  },
  data () {
    return {
      query: {},
      loginUser: {},
      showSetting: false,
      showApply: false,
      retailerInfo: {},
      submitdata: { title: '', qrcode: '', buyonline: 1, content: '', fastreply: '你好，请稍等，一会为你服务' },
      submitdata1: { showphoto: '', slogan: '', tags: '' },
      photoarr: [],
      showphotoArr: [],
      classData: []
    }
  },
  methods: {
    applySuccess () {
      const self = this
      self.initContainer()
      self.showSetting = true
      self.$vux.loading.hide()
    },
    getData () {
      const self = this
      self.loginUser = User.get()
      self.$http.get(`${ENV.BokaApi}/api/retailer/home`)
      .then(res => {
        self.$vux.loading.hide()
        if (res) {
          let data = res.data
          self.$vux.loading.hide()
          self.retailerInfo = data.data ? data.data : data
          for (let key in self.submitdata) {
            self.submitdata[key] = self.retailerInfo[key]
          }
          for (let key in self.submitdata1) {
            self.submitdata1[key] = self.retailerInfo[key]
          }
          let qrcode = self.submitdata.qrcode
          if (qrcode && self.$util.trim(qrcode) !== '') {
            self.photoarr = qrcode.split(',')
          }
          let showphoto = self.submitdata1.showphoto
          if (showphoto && self.$util.trim(showphoto) !== '') {
            self.showphotoArr = showphoto.split(',')
          }
        }
      })
    },
    init () {
      this.$http.post(`${ENV.BokaApi}/api/retailer/logAction`, {
        module: 'retailer', action: 'setting'
      })
    },
    initContainer () {
      const self = this
      self.showApply = false
      self.showSetting = false
    },
    refresh () {
      const self = this
      this.$store.commit('updateToggleTabbar', {toggleTabbar: false})
      this.$vux.loading.show()
      this.loginUser = User.get()
      this.query = this.$route.query
      if (this.loginUser && (this.loginUser.subscribe === 1 || this.loginUser.isretailer)) {
        // if (self.loginUser.isretailer === 2) {
        //   self.initContainer()
        //   self.$vux.loading.hide()
        //   let backUrl = encodeURIComponent(location.href)
        //   location.replace(`${ENV.Host}/#/pay?id=${self.loginUser.payorderid}&module=payorders&lasturl=${backUrl}`)
        // } else {
        self.initContainer()
        if (!this.loginUser.isretailer) {
          self.initContainer()
          this.showApply = true
          self.$http.get(`${ENV.BokaApi}/api/list/applyclass?ascdesc=asc`,
            { params: { limit: 100 } }
          ).then(function (res) {
            self.$vux.loading.hide()
            if (res.status === 200) {
              let data = res.data
              data = data.data ? data.data : data
              for (let i = 0; i < data.length; i++) {
                data[i].checked = false
              }
              self.classData = data
            }
          })
        } else {
          self.$vux.loading.hide()
          self.initContainer()
          self.showSetting = true
          this.getData()
        }
        // }
      }
    }
  },
  created () {
    this.init()
  },
  activated () {
    this.refresh()
    this.$util.miniPost()
  }
}
</script>

<style lang="less" scoped>
.form-item{position:relative;padding:10px;}
.form-item:after{
  content:"";display:block;
	background-color:@list-border-color;height:1px;overflow:hidden;
	position: absolute;left: 0;right: 0;bottom:1px;
	-webkit-transform: scaleY(0.5) translateY(0.5px);
	transform: scaleY(0.5) translateY(0.5px);
	-webkit-transform-origin: 0% 0%;
	transform-origin: 0% 0%;
}
</style>
