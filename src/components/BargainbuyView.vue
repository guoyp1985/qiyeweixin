<template>
  <div class="containerarea font14 bargainbuyview" style="overflow-y:auto;">
    <div class="topimg">
      <img src="../assets/images/bargainbuy_2.png">
    </div>
    <div class="b_header">
      <div class="inner">
        <div class="pic">
          <img :src="crowduser.avatar">
        </div>
        <div class="clamp1 font13 color-gray7 pt5 align_center mauto" style="width:168px;">{{ crowduser.linkman }}</div>
      </div>
    </div>
    <div class="boxarea">
      <div class="inner">
        <div class="innerbg">
          <router-link class="t-table" style="color:inherit;" :to="{path:'/product',query:{wid:product.uploader,id:product.id}}">
            <div class="t-cell v_middle w80">
              <img :src="product.photo" style="width:70px;height:70px;" class="imgcover" />
            </div>
            <div class="t-cell">
              <div class="clamp2 font13 color-gray7">{{ product.title }}</div>
              <div class="clamp1 font13" style="color:#E02D24;">最低价：<span class="font16 bold">{{ data.minprice }}</span> 元<del class="ml10 color-gray7">原价：{{ product.price }} 元</del></div>
              <div class="clamp1 font13" style="color:#E02D24;">剩  余：<span class="font16 bold">{{ data.leftstorage }}</span> 件</div>
            </div>
          </router-link>
        </div>
      </div>
    </div>
    <div class="mauto align_center" style="width: 94%;height: 5px;">
      <div class="mauto h_100" style="border-left:3px solid #FDC45D;border-right:3px solid #FDC45D;width: 45%;"></div>
    </div>
    <div class="boxarea1">
      <div class="inner">
        <div class="pricearea">
          <div class="t-table">
            <div class="t-cell align_left">原价</div>
            <div class="t-cell align_center">已砍到</div>
            <div class="t-cell align_right">最低价</div>
          </div>
          <div class="priceline">
            <div class="line linepercent" :style="`width:${crowduser.cutpercent}%;`"></div>
          </div>
          <div class="t-table">
            <div class="t-cell align_left">￥{{ product.price }}</div>
            <div class="t-cell align_center">￥{{ crowduser.leftmoney }}</div>
            <div class="t-cell align_right">￥{{ data.minprice }}</div>
          </div>
        </div>
        <div v-if="data.leftstorage <= 0" class="btn">商品已售罄，本次活动结束</div>
        <template v-else>
          <div v-if="data.isovertime" class="btn">指定时间内未完成砍价，砍价失败</div>
          <template v-else>
            <div v-if="crowduser.isdeliver == 0 && crowduser.isfull == 1" class="btn" @click="buyevent">立即购买 {{  $t('RMB') }}{{ crowduser.leftmoney }}</div>
            <div v-if="crowduser.isdeliver == 1" class="btn">已发起购买,砍价结束</div>
            <template v-if="crowduser.isfull == 0">
              <div class="btn db" @click="inviteevent">邀请好友砍价</div>
              <div v-if="crowduser" class="pt10 pb10 align_center timeleftarea font13" style="color:#A87F35; ">
                <span class="v_middle db-in">还剩</span>
                <span class="v_middle db-in">{{ lefthour }}</span>
                <span class="v_middle db-in">:</span>
                <span class="v_middle db-in">{{ leftminute }}</span>
                <span class="v_middle db-in">:</span>
                <span class="v_middle db-in">{{ leftsecond }}</span>
                <span class="v_middle db-in">结束，快让好友帮忙砍价吧~</span>
              </div>
            </template>
          </template>
        </template>
      </div>
    </div>
    <div>
      <div class="boxtitle">砍价亲友团</div>
      <div class="titleline">
        <div class="inner" style="background: #C93A3A;border-radius: 100px;height: 8px;width: 100%;"></div>
      </div>
      <div class="listarea">
        <div class="scroll_list">
          <div v-if="cutdata.length == 0" class="scroll_item emptyitem" style="padding:0;">
              <div class="t-table">
                <div class="t-cell middle-cell" style="color:inherit;">还没有好友砍价</div>
              </div>
          </div>
          <div v-else v-for="(item,index) in cutdata" :key="item.id" class="scroll_item">
            <div class="t-table" style="height:60px;">
              <div class="t-cell v_middle" style="width:55px;">
                <img class="v_middle" style="width:44px;height:44px;border-radius:50%;" :src="item.avatar" />
              </div>
              <div class="t-cell v_middle" style="padding-right:25px;">
                <div class="clamp1 font13">{{ item.linkman }}</div>
              </div>
              <div class="t-cell align_right v_middle pr10" style="width:130px;">
                <div class="font13" style="color:#C93A3A">
                  <img class="v_middle" src="../assets/images/bargainbuy_3.png" style="width: 21px;height:19px;">  砍掉 <span class="font16 bold">{{ item.cutmoney }}</span> 元
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div v-transfer-dom class="x-popup">
      <popup v-model="showpopup" height="100%">
        <div class="popup1 invitelayer" @click="closeinvite">
          <div class="iconarea" style="padding:15px 40px;"><i class="al al-feiji font60" style="color:rgba(255,255,255,0.9)"></i></div>
          <div class="txtarea align_center color-fff font16" style="line-height:26px;text-shadow: -2px 0px 1px #000;">点击右上角“···”发送给微信好友<br>邀请对方帮你砍价！</div>
        </div>
      </popup>
    </div>
  </div>
</template>

<i18n>
</i18n>

<script>
import { TransferDom, Popup } from 'vux'
import ENV from '#/env'

export default {
  name: 'BargainbuyView',
  props: {
    data: Object,
    crowduser: {
      type: Object,
      default: { 'avatar': '/src/assets/images/user.jpg' }
    },
    user: {
      type: Object,
      default: { 'avatar': '/src/assets/images/user.jpg' }
    },
    onJoin: Function
  },
  directives: {
    TransferDom
  },
  components: {
    Popup
  },
  data () {
    return {
      query: {},
      loginUser: Object,
      product: Object,
      showpopup: false,
      lefthour: '',
      leftminute: '',
      leftsecond: '',
      cutdata: []
    }
  },
  created () {
    const self = this
    self.query = self.$route.query
    if (self.data) {
      self.product = self.data.product
    }
    console.log(self.crowduser)
    if (self.crowduser) {
      self.lefthour = self.crowduser.timeleft.hour
      self.leftminute = self.crowduser.timeleft.minute
      self.leftsecond = self.crowduser.timeleft.second
      self.cutdown()
    }
    self.$http.post(`${ENV.BokaApi}/api/activity/bargainUsers`, { id: self.crowduser.id }).then(function (res) {
      let data = res.data
      self.cutdata = data.data ? data.data : data
    })
  },
  methods: {
    inviteevent () {
      this.showpopup = true
    },
    closeinvite () {
      this.showpopup = false
    },
    cutdown () {
      const self = this
      let cutdownInterval = setInterval(function () {
        let h = parseInt(self.lefthour)
        let m = parseInt(self.leftminute)
        let s = parseInt(self.leftsecond)
        if (s > 0) {
          s--
          if (s < 10) {
            self.leftsecond = '0' + s
          } else {
            self.leftsecond = s
          }
        } else if (m > 0) {
          m--
          if (m < 10) {
            self.leftminute = '0' + m
          } else {
            self.leftminute = m
          }
          self.leftsecond = '59'
        } else if (h > 0) {
          h--
          if (h < 10) {
            self.lefthour = '0' + h
          } else {
            self.lefthour = h
          }
          self.leftminute = '59'
          self.leftsecond = '59'
        }
        if (h === 0 && m === 0 && s === 0) {
          clearInterval(cutdownInterval)
          self.isfinish = true
        }
      }, 1000)
    },
    buyevent () {
      const self = this
      self.$vux.confirm.show({
        title: '确定要购买吗？',
        onConfirm () {
          self.$vux.loading.show()
          let params = { id: self.product.id, flag: 1, quantity: 1, activityid: self.data.id, wid: self.product.uploader }
          if (self.query.share_uid) {
            params.share_uid = self.query.share_uid
          }
          self.$http.post(`${ENV.BokaApi}/api/order/addShop`, params).then(function (res) {
            let data = res.data
            self.$vux.loading.hide()
            if (data.flag === 1) {
              self.$router.push({ path: '/addOrder', query: { id: self.product.id } })
            } else if (data.error) {
              self.$vux.toast.show({
                text: data.error,
                time: self.$util.delay(data.error)
              })
            }
          })
        }
      })
    }
  }
}
</script>

<style lang="less">
.bargainbuyview {
    background-image: linear-gradient(-180deg, #f32a3d 0%, #FF8048 100%);
}
.bargainbuyview .topimg{position:absolute;left:0;top:0;width:100%;}
.bargainbuyview .topimg img{width:100%;max-height:240px;vertical-align: middle;}
.bargainbuyview .b_header{width:100%;height:90px;padding-top:30px;overflow:hidden;position: relative;}
.bargainbuyview .b_header .inner {
    width: 168px;
    height: 168px;
    box-sizing:border-box;
    padding-top:8px;
    border-top-left-radius: 50%;
    border-top-right-radius: 50%;
    background: #FDC45D;
    margin:0 auto;
}
.bargainbuyview .b_header .pic{width:60px;margin:0 auto;}
.bargainbuyview .b_header .pic img{width:60px;height:60px;border-radius:50%;vertical-align:middle;}
.bargainbuyview .boxarea {
  width: 94%;
  box-sizing:border-box;
  position:relative;
  margin:-1px auto 0;
  background: #FDC45D;
  border-radius: 13px;
  padding: 16px 12px 16px 12px;
}
.bargainbuyview .boxarea .inner {
    border-radius: 8px;
    background: white;
    margin-top: 5px;
    padding: 7px 6px 7px 6px;
    position: relative;
    cursor: pointer;
}
.bargainbuyview .boxarea .innerbg {
    border-radius: 7px;
    background: #F7F7F7;
    padding: 6px;
}
.bargainbuyview .boxarea .pic{width:80px;}
.bargainbuyview .boxarea .pic img{width:70px;height:70px;vertical-align:middle;}

.bargainbuyview .boxarea1{width:94%;margin:0 auto;}
.bargainbuyview .boxarea1 .inner{
  background-color: #FDC45D;border-radius: 13px;padding:11px 15px 8px 15px;
}
.bargainbuyview .boxarea1 .pricearea{
  width: 90%;
  margin: 20px auto 0;
  color: #C93A3A;
}
.bargainbuyview .priceline {
  margin: 12px auto;
  background-color: rgba(255, 255, 255, 0.75);
  width: 100%;
  height: 10px;
  border-radius: 5px;
}
.bargainbuyview .line {
  width: 0%;
  height: 100%;
  background-image: linear-gradient(0deg, #EC3F57 0%, #FF8147 99%);
  border-radius: 5px;
}
.bargainbuyview .btn{
  width: 90%;
  background-image: linear-gradient(90deg, #EC3F57 0%, #FF8147 99%);
  box-shadow: 0 5px 8px 0 #C13123;
  border-radius: 100px;
  height: 44px;
  line-height: 44px;
  text-align: center;
  color: white;
  font-size: 14px;
  margin: 16px auto 10px auto;
  cursor: pointer;
}
.bargainbuyview .boxtitle {
    background: #C93A3A;
    border-radius: 6px 6px 0 0;
    width: 160px;
    height: 24px;
    line-height: 24px;
    font-size: 13px;
    color: #FFE0A0;
    text-align: center;
    margin: 20px auto 0px auto;
}
.bargainbuyview .titleline{
  width: 94%;padding-left: 24px;padding-right: 24px;margin:0 auto;
  box-sizing: border-box;
}
.bargainbuyview .titleline .inner{
  background: #C93A3A;border-radius: 100px;height: 8px;width: 100%;
}
.bargainbuyview .listarea{
  background: #F8F8F8; border-radius: 24px;padding: 1px 12px 1px 12px;margin: -5px 5px 5px 5px;
  box-sizing: border-box;
}
.bargainbuyview .scroll_list{margin:20px auto;}
.bargainbuyview .listarea .scroll_item {
    border-radius: 6px;
    padding-left: 10px;
    height: 60px;
    margin-top: 10px;
    background-color: #E0E0E0;
}
.invitelayer{width:100%;height:100%;position:relative;background: rgba(0, 0, 0, 0.85);}
.invitelayer .iconarea{text-align:right;padding:15px 40px;color:rgba(255,255,255,0.9);}
.invitelayer .txtarea{
  text-align:center;color:#fff;font-size:16px;
  line-height:26px;text-shadow: -2px 0px 1px #000;
}
</style>
